# =============================================================================
# F2X NeuroHub MES - Production Auto-Deploy Workflow
# Triggers on push to main branch, runs on self-hosted Windows runner
# =============================================================================

name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'neurohub_client/**'  # PySide6 클라이언트 변경은 배포 트리거 안함

  # 수동 배포 트리거 (GitHub UI에서 실행 가능)
  workflow_dispatch:

# 배포 충돌 방지 - 동시 실행 시 대기
concurrency:
  group: deploy
  cancel-in-progress: false

env:
  COMPOSE_FILES: -f docker-compose.yml -f docker-compose.prod.yml
  ENV_FILE: .env.production
  HTTP_PORT: 9090

jobs:
  deploy:
    name: Deploy to Windows Server
    runs-on: self-hosted

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 환경 변수 파일 확인
      - name: Check environment file
        run: |
          if (!(Test-Path "${{ env.ENV_FILE }}")) {
            Write-Error "${{ env.ENV_FILE }} file not found!"
            exit 1
          }
          Write-Host "Environment file found"
        shell: powershell

      # 3. Docker 상태 확인
      - name: Check Docker status
        run: |
          docker --version
          docker compose version
        shell: powershell

      # 4. 이전 컨테이너 중지 (있으면)
      - name: Stop existing containers
        run: |
          docker compose ${{ env.COMPOSE_FILES }} --env-file ${{ env.ENV_FILE }} down --remove-orphans
        shell: powershell
        continue-on-error: true

      # 5. Docker 이미지 빌드
      - name: Build Docker images
        run: |
          docker compose ${{ env.COMPOSE_FILES }} --env-file ${{ env.ENV_FILE }} build --no-cache
        shell: powershell

      # 6. 서비스 시작
      - name: Start services
        run: |
          docker compose ${{ env.COMPOSE_FILES }} --env-file ${{ env.ENV_FILE }} up -d
        shell: powershell

      # 7. 서비스 준비 대기
      - name: Wait for services to be ready
        run: |
          Write-Host "Waiting for services to start..."
          Start-Sleep -Seconds 20
        shell: powershell

      # 8. 헬스체크
      - name: Health check
        run: |
          $maxRetries = 5
          $retryCount = 0
          $success = $false

          while ($retryCount -lt $maxRetries -and -not $success) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:${{ env.HTTP_PORT }}/health" -UseBasicParsing -TimeoutSec 10
              if ($response.StatusCode -eq 200) {
                Write-Host "Health check passed!"
                $success = $true
              }
            } catch {
              $retryCount++
              Write-Host "Health check failed, retry $retryCount/$maxRetries..."
              Start-Sleep -Seconds 5
            }
          }

          if (-not $success) {
            Write-Error "Health check failed after $maxRetries retries"
            exit 1
          }
        shell: powershell

      # 9. DB 마이그레이션
      - name: Run database migrations
        run: |
          docker compose ${{ env.COMPOSE_FILES }} --env-file ${{ env.ENV_FILE }} exec -T backend alembic upgrade head
        shell: powershell
        continue-on-error: true

      # 10. 배포 완료 상태 확인
      - name: Deployment status
        run: |
          Write-Host "=== Deployment Complete ==="
          docker compose ${{ env.COMPOSE_FILES }} --env-file ${{ env.ENV_FILE }} ps
        shell: powershell

      # 11. Docker 이미지 정리 (디스크 공간 확보)
      - name: Cleanup Docker images
        run: |
          Write-Host "=== Cleaning up unused Docker images ==="
          docker image prune -f
        shell: powershell
        continue-on-error: true
