# =============================================================================
# F2X NeuroHub MES - Demo Deploy Workflow
# ìˆ˜ë™ íŠ¸ë¦¬ê±° ì „ìš© - Prodë¥¼ ì¤‘ì§€í•˜ê³  Demoë¡œ êµì²´
# =============================================================================

name: Deploy Demo (Replace Prod)

on:
  # ìˆ˜ë™ ë°°í¬ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      reset_database:
        description: 'DB ì™„ì „ ì´ˆê¸°í™” (ê¸°ì¡´ ë°ì´í„° ëª¨ë‘ ì‚­ì œ)'
        required: false
        type: boolean
        default: false

  # ìë™ ë°°í¬: main ë¸Œëœì¹˜ push ì‹œ
  push:
    branches:
      - main

# ë°°í¬ ì¶©ëŒ ë°©ì§€ - ë™ì‹œ ì‹¤í–‰ ì‹œ ëŒ€ê¸°
concurrency:
  group: deploy
  cancel-in-progress: false

env:
  COMPOSE_FILES_PROD: -f docker-compose.yml -f docker-compose.prod.yml
  COMPOSE_FILES_DEMO: -f docker-compose.yml -f docker-compose.demo.yml
  ENV_FILE_PROD: .env.production
  ENV_FILE_DEMO: .env.demo

jobs:
  deploy-demo:
    name: Deploy Demo (Replace Prod)
    runs-on: self-hosted

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
      - name: Check environment file
        run: |
          if (!(Test-Path "${{ env.ENV_FILE_DEMO }}")) {
            Write-Error "${{ env.ENV_FILE_DEMO }} file not found!"
            exit 1
          }
          Write-Host "Demo environment file found"
        shell: powershell

      # 3. Docker ìƒíƒœ í™•ì¸
      - name: Check Docker status
        run: |
          docker --version
          docker compose version
        shell: powershell

      # 4. Prod ì»¨í…Œì´ë„ˆ ì¤‘ì§€
      - name: Stop Prod containers
        run: |
          Write-Host "=== Stopping Prod containers ==="
          docker compose ${{ env.COMPOSE_FILES_PROD }} --env-file ${{ env.ENV_FILE_PROD }} down --remove-orphans
        shell: powershell
        continue-on-error: true

      # 5. Demo ë³¼ë¥¨ ë¦¬ì…‹ (DB ì´ˆê¸°í™”) - ì„ íƒì 
      - name: Reset Demo volumes
        if: ${{ github.event.inputs.reset_database == 'true' }}
        run: |
          Write-Host "=== Resetting Demo database volume ==="
          docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} down -v --remove-orphans
          Write-Host "Demo volumes removed"
        shell: powershell
        continue-on-error: true

      # 6. Demo Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Demo Docker images
        run: |
          docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} build --no-cache
        shell: powershell

      # 7. Demo ì„œë¹„ìŠ¤ ì‹œì‘
      - name: Start Demo services
        run: |
          docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} up -d
        shell: powershell

      # 8. ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
      - name: Wait for services to be ready
        run: |
          Write-Host "Waiting for Demo services to start..."
          Start-Sleep -Seconds 20
        shell: powershell

      # 9. í—¬ìŠ¤ì²´í¬
      - name: Health check
        run: |
          $maxRetries = 5
          $retryCount = 0
          $success = $false

          while ($retryCount -lt $maxRetries -and -not $success) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:9090/health" -UseBasicParsing -TimeoutSec 10
              if ($response.StatusCode -eq 200) {
                Write-Host "Health check passed!"
                $success = $true
              }
            } catch {
              $retryCount++
              Write-Host "Health check failed, retry $retryCount/$maxRetries..."
              Start-Sleep -Seconds 5
            }
          }

          if (-not $success) {
            Write-Error "Health check failed after $maxRetries retries"
            exit 1
          }
        shell: powershell

      # 10. DB ë§ˆì´ê·¸ë ˆì´ì…˜ (ì•ˆì „í•œ ì—…ê·¸ë ˆì´ë“œ)
      - name: Run database migrations
        run: |
          # PowerShellì´ stderr ì¶œë ¥ì„ ì—ëŸ¬ë¡œ ì¸ì‹í•˜ì—¬ ì¤‘ë‹¨ë˜ëŠ” ê²ƒì„ ë°©ì§€
          $ErrorActionPreference = "Continue"
          Write-Host "=== Running database migrations ==="
          
          # 1. í˜„ì¬ ìƒíƒœ í™•ì¸
          docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} exec -T backend alembic history
          
          # 2. Upgrade ì‹œë„
          $result = & docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} exec -T backend alembic upgrade head 2>&1 | Out-String
          Write-Host $result
          
          # ì¢…ë£Œ ì½”ë“œê°€ 0ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§ ì‹¤í–‰
          if ($LASTEXITCODE -ne 0) {
            if ($result -match "refresh_tokens.*already exists" -or $result -match "DuplicateTable.*refresh_tokens") {
              Write-Host "refresh_tokens table exists. Stamping to e2f4a1b2c3d4 and continuing..."
              docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} exec -T backend alembic stamp e2f4a1b2c3d4
              docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} exec -T backend alembic upgrade head
            } elseif ($result -match "already exists" -or $result -match "DuplicateTable") {
              Write-Host "Tables exist but migration failed. Trying to stamp to head..."
              docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} exec -T backend alembic stamp head
            } else {
              Write-Error "Migration failed with exit code $LASTEXITCODE"
              exit 1
            }
          } else {
            Write-Host "Migration completed successfully"
          }
        shell: powershell

      # 11. Seed ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± (ë¹„í™œì„±í™” - ë¹ˆ ìŠ¤í‚¤ë§ˆ ì‚¬ìš©)
      # - name: Seed performance test data
      #   if: ${{ github.event.inputs.reset_database == 'true' }}
      #   run: |
      #     Write-Host "=== Generating performance test data ==="
      #     docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} exec -T backend python scripts/seed_performance_data.py --reset
      #   shell: powershell

      # 12. ë°°í¬ ì™„ë£Œ ìƒíƒœ í™•ì¸
      - name: Deployment status
        run: |
          Write-Host "=== Demo Deployment Complete ==="
          if ("${{ github.event.inputs.reset_database }}" -eq "true") {
            Write-Host "ğŸ”„ Database RESET: Fresh database with empty schema"
          } else {
            Write-Host "âœ… Database PRESERVED: Code updated, data retained"
          }
          Write-Host "âš ï¸ Prod is stopped. Run 'Restore Prod' workflow to restore."
          docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} ps
        shell: powershell

      # 13. Docker ì´ë¯¸ì§€ ì •ë¦¬ (ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
      - name: Cleanup Docker images
        run: |
          Write-Host "=== Cleaning up unused Docker images ==="
          docker image prune -f
        shell: powershell
        continue-on-error: true
