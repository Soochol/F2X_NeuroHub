# =============================================================================
# F2X NeuroHub MES - Demo Deploy Workflow
# 수동 트리거 전용 - Prod를 중지하고 Demo로 교체
# =============================================================================

name: Deploy Demo (Replace Prod)

on:
  # 수동 배포 트리거만 (GitHub UI에서 실행)
  workflow_dispatch:
    inputs:
      confirm:
        description: '⚠️ Prod를 중지하고 Demo로 교체합니다. "yes"를 입력하세요'
        required: true
        default: ''

env:
  COMPOSE_FILES_PROD: -f docker-compose.yml -f docker-compose.prod.yml
  COMPOSE_FILES_DEMO: -f docker-compose.yml -f docker-compose.demo.yml
  ENV_FILE_PROD: .env.production
  ENV_FILE_DEMO: .env.demo

jobs:
  deploy-demo:
    name: Deploy Demo (Replace Prod)
    runs-on: self-hosted
    if: ${{ github.event.inputs.confirm == 'yes' }}

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 환경 변수 파일 확인
      - name: Check environment file
        run: |
          if (!(Test-Path "${{ env.ENV_FILE_DEMO }}")) {
            Write-Error "${{ env.ENV_FILE_DEMO }} file not found!"
            exit 1
          }
          Write-Host "Demo environment file found"
        shell: powershell

      # 3. Docker 상태 확인
      - name: Check Docker status
        run: |
          docker --version
          docker compose version
        shell: powershell

      # 4. Prod 컨테이너 중지
      - name: Stop Prod containers
        run: |
          Write-Host "=== Stopping Prod containers ==="
          docker compose ${{ env.COMPOSE_FILES_PROD }} --env-file ${{ env.ENV_FILE_PROD }} down --remove-orphans
        shell: powershell
        continue-on-error: true

      # 5. Demo Docker 이미지 빌드
      - name: Build Demo Docker images
        run: |
          docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} build --no-cache
        shell: powershell

      # 6. Demo 서비스 시작
      - name: Start Demo services
        run: |
          docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} up -d
        shell: powershell

      # 7. 서비스 준비 대기
      - name: Wait for services to be ready
        run: |
          Write-Host "Waiting for Demo services to start..."
          Start-Sleep -Seconds 20
        shell: powershell

      # 8. 헬스체크
      - name: Health check
        run: |
          $maxRetries = 5
          $retryCount = 0
          $success = $false

          while ($retryCount -lt $maxRetries -and -not $success) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:9090/health" -UseBasicParsing -TimeoutSec 10
              if ($response.StatusCode -eq 200) {
                Write-Host "Health check passed!"
                $success = $true
              }
            } catch {
              $retryCount++
              Write-Host "Health check failed, retry $retryCount/$maxRetries..."
              Start-Sleep -Seconds 5
            }
          }

          if (-not $success) {
            Write-Error "Health check failed after $maxRetries retries"
            exit 1
          }
        shell: powershell

      # 9. DB 마이그레이션 (기존 테이블 있으면 stamp, 없으면 upgrade)
      - name: Run database migrations
        run: |
          Write-Host "=== Running database migrations ==="
          # 먼저 upgrade 시도
          $result = docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} exec -T backend alembic upgrade head 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Migration failed, checking if tables already exist..."
            # 테이블이 이미 존재하면 현재 버전으로 stamp
            if ($result -match "DuplicateTable" -or $result -match "already exists") {
              Write-Host "Tables already exist. Stamping current migration version..."
              docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} exec -T backend alembic stamp head
            } else {
              Write-Host "Migration error: $result"
            }
          } else {
            Write-Host "Migration completed successfully"
          }
        shell: powershell
        continue-on-error: true

      # 10. Seed 성능 테스트 데이터 생성
      - name: Seed performance test data
        run: |
          Write-Host "=== Generating performance test data ==="
          docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} exec -T backend python scripts/seed_performance_data.py --reset
        shell: powershell

      # 11. 배포 완료 상태 확인
      - name: Deployment status
        run: |
          Write-Host "=== Demo Deployment Complete ==="
          Write-Host "⚠️ Prod is stopped. Run 'Restore Prod' workflow to restore."
          docker compose ${{ env.COMPOSE_FILES_DEMO }} --env-file ${{ env.ENV_FILE_DEMO }} ps
        shell: powershell
